---
title: "Urban Western Cape nonnative plant inventory analysis"
author: "Christiaan Petrus Gildenhuys"
date: "2025-08-08"
output:
  word_document: default
  html_document: default
---

```{r echo = FALSE}
rm(list = ls())
#knitr::opts_chunk$set(fig.width = 6, fig.height = 4)
knitr::opts_chunk$set(
	fig.height = 9,
	fig.width = 14,
	dpi = 300
#	out.width = "80%"
)
```


```{r include=FALSE}
library(tidyverse)
library(rWCVPdata)

wcvp_distributions<-wcvp_distributions
wcvp_names<-wcvp_names
```

```{r warning=FALSE, include=FALSE}
setwd("~/sANNIC_workflow")
nonnative_records<-read_csv2("Output/Western Cape urban non-native records 1 February 2025.csv")
nonnative_inventory<-read_csv2("Output/Western Cape urban non-native plant inventory 1 February 2025.csv")
PI_scores<-read_csv2("Output/Nonnative inventory prevalence index scores.csv")
Special_cases<-read_csv2("Input/Problem_taxa.csv")
head(nonnative_records)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
nonnative_inventory2<-
nonnative_inventory%>%
  left_join(wcvp_names%>%
              select(plant_name_id,lifeform_description,climate_description,family)%>%
              rename(wcvp_id_full = plant_name_id))%>%
  left_join(PI_scores%>%
              select(Species,PI,num_areas)%>%
              rename(taxon = Species))%>%
  filter(wcvp_rank != "Genus" | special_case == T)
```


## The most abundant families in the inventory

```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(family)%>%
  summarise(obs = length(family))%>%
  mutate(family = fct_reorder(family,-obs))%>%
  mutate(family = fct_other(family, keep = subset(as.character(.$family),obs>6)))%>%
  ggplot(aes(family,obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 12))+
  ylab("Number of species")+
  xlab("Family")
```

**Supplementary figure 1**: Most represented plant families by number of species in the Western Cape urban areas.





```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(family)%>%
  summarise(sum_obs = sum(PI))%>%
  mutate(family = fct_reorder(family,-sum_obs))%>%
  mutate(family = fct_other(family, keep = subset(as.character(.$family),sum_obs>3)))%>%
  ggplot(aes(family,sum_obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 12))+
  ylab("Species weighted by PI")+
  xlab("Family")
```

**Supplementary figure 2**: Most represented plant families of species weighted by their prevalence index scores in the Western Cape urban areas.



```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(family)%>%
  summarise(sum_obs = sum(num_obs))%>%
  mutate(family = fct_reorder(family,-sum_obs))%>%
  mutate(family = fct_other(family, keep = subset(as.character(.$family),sum_obs>300)))%>%
  ggplot(aes(family,sum_obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 12))+
  ylab("Number of observations")+
  xlab("Family")
```

**Supplementary figure 3**: Most represented plant families by number of total observations in the Western Cape urban areas.





## Lifeform description
```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(lifeform_description)%>%
  summarise(obs = length(taxon))%>%
  group_by(lifeform_description)%>%
  summarise(obs = sum(obs))%>%
  group_by(lifeform_description)%>%
  mutate(sum_obs = sum(obs))%>%
  mutate(lifeform_description = fct_other(lifeform_description, 
                                          keep = subset(as.character(.$lifeform_description),sum_obs>5)))%>%
  ggplot(aes(reorder(lifeform_description,-sum_obs),obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 14))+
  ylab("Number of species")+
  xlab("Life form description")

```

**Supplementary figure 4**: Most common life form descriptions of nonnative plant species in the Western Cape as reported in the WCVP.

```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(lifeform_description)%>%
  summarise(obs = sum(num_obs))%>%
  group_by(lifeform_description)%>%
  summarise(obs = sum(obs))%>%
  group_by(lifeform_description)%>%
  mutate(sum_obs = sum(obs))%>%
  mutate(lifeform_description = fct_other(lifeform_description, 
                                          keep = subset(as.character(.$lifeform_description),sum_obs>500)))%>%
  ggplot(aes(reorder(lifeform_description,-sum_obs),obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 14))+
  ylab("Number of observations")+
  xlab("Life form description")

```

**Supplementary figure 5**: Most common life form descriptions by number of observations of nonnative plant species in the Western Cape urban areas.

```{r echo=FALSE}
nonnative_inventory2%>%
  group_by(lifeform_description)%>%
  summarise(obs = sum(PI))%>%
  group_by(lifeform_description)%>%
  summarise(obs = sum(obs))%>%
  group_by(lifeform_description)%>%
  mutate(sum_obs = sum(obs))%>%
  mutate(lifeform_description = fct_other(lifeform_description, 
                                          keep = subset(as.character(.$lifeform_description),sum_obs>5)))%>%
  ggplot(aes(reorder(lifeform_description,-sum_obs),obs))+
  geom_col(fill = "black")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 14))+
  ylab("Species weighted by PI")+
  xlab("Life form description")

```

**Supplementary figure 6**: Most common life form descriptions of of nonnative plant species weighted by prevalence index scores in the Western Cape urban areas.

```{r message=FALSE, warning=FALSE, include=FALSE}

glonaf_flora2<-
  read.csv2("C:/Users/chris/OneDrive - Stellenbosch University/Documents/Cotoneaster_review/GloNAF 2024/glonaf_flora2.csv")

glonaf_taxon<-
  read.csv2("C:/Users/chris/OneDrive - Stellenbosch University/Documents/Cotoneaster_review/GloNAF 2024/glonaf_taxon_wcvp.csv")

glonaf_region<-
  read.csv2("C:/Users/chris/OneDrive - Stellenbosch University/Documents/Cotoneaster_review/GloNAF 2024/glonaf_region.csv")


glonaf_nonnative_list_WC<-
  left_join(glonaf_flora2,
            glonaf_taxon%>%
              rename(taxon_wcvp_id = id)%>%
              select(taxon_wcvp_id,accepted_plant_name_id,taxa_accepted,taxon_orig,taxon_corrected))%>%
  left_join(glonaf_region%>%
              rename(region_id = id)%>%
              select(code,name,region_id,tdwg4_id))%>%
  filter(tdwg4_id == "CPP-WC")%>%
  separate(taxa_accepted,sep = " ",
           into = c("Genus","species"),
           remove = F)%>%
  mutate(taxon = case_when(Genus %in% Special_cases$Name ~ paste(Genus),
                           Genus == "Oenothera" & species == "lindheimeri" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" & species == "rosea" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" ~ "sect Oenothera",
                           .default = paste(Genus,species,sep = " ")))%>%
  select(taxon)%>%
  unique()%>%
  mutate(glonaf = 1)#%>%view()

glonaf_nonnative_list_SA<-
  left_join(glonaf_flora2,
            glonaf_taxon%>%
              rename(taxon_wcvp_id = id)%>%
              select(taxon_wcvp_id,accepted_plant_name_id,taxa_accepted,taxon_orig,taxon_corrected))%>%
  left_join(glonaf_region%>%
              rename(region_id = id)%>%
              select(code,name,region_id,tdwg4_id))%>%
  filter(str_starts(code,"ZAF"))%>%
  separate(taxa_accepted,sep = " ",
           into = c("Genus","species"),
           remove = F)%>%
  mutate(taxon = case_when(Genus %in% Special_cases$Name ~ paste(Genus),
                           Genus == "Oenothera" & species == "lindheimeri" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" & species == "rosea" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" ~ "sect Oenothera",
                           .default = paste(Genus,species,sep = " ")))%>%
  select(taxon)%>%
  unique()%>%
  mutate(glonaf = 1)#%>%view()

glonaf_nonnative_list_global<-
  left_join(glonaf_flora2,
            glonaf_taxon%>%
              rename(taxon_wcvp_id = id)%>%
              select(taxon_wcvp_id,accepted_plant_name_id,taxa_accepted,taxon_orig,taxon_corrected))%>%
  left_join(glonaf_region%>%
              rename(region_id = id)%>%
              select(code,name,region_id,tdwg4_id))%>%
  separate(taxa_accepted,sep = " ",
           into = c("Genus","species"),
           remove = F)%>%
  mutate(taxon = case_when(Genus %in% Special_cases$Name ~ paste(Genus),
                           Genus == "Oenothera" & species == "lindheimeri" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" & species == "rosea" ~ paste(Genus,species,sep = " "),
                           Genus == "Oenothera" ~ "sect Oenothera",
                           .default = paste(Genus,species,sep = " ")))%>%
  select(taxon)%>%
  unique()%>%
  mutate(glonaf = 1)#%>%view()

```

## Compare the sANNIC-derived nonnative inventory to the GloNAF inventory for the Western Cape

```{r echo=FALSE, message=FALSE, warning=FALSE}
A<-nonnative_inventory2%>%
  select(taxon)%>%
  mutate(taxon = str_remove_all(taxon,"\\Ã— "))%>%
  mutate(sANNIC = 1)

B<-glonaf_nonnative_list_WC%>%
  mutate(glonaf_WC = 1)%>%
  mutate(across(everything(), ~replace_na(.,0)))

C <- glonaf_nonnative_list_SA%>%
  mutate(glonaf_SA = 1)%>%
  mutate(across(everything(), ~replace_na(.,0)))

D <- glonaf_nonnative_list_global%>%
  mutate(glonaf_global = 1)%>%
  mutate(across(everything(), ~replace_na(.,0)))

left_join(A,B)%>%
  left_join(C)%>%
  left_join(D)%>%
  mutate(across(everything(), ~replace_na(.,0)))%>%view()

```




```{r echo=FALSE}

library(eulerr)
a <- A$taxon
b <- B$taxon
c <- C$taxon
d <- D$taxon

fit <- euler(list(`sANNIC workflow output` = a, 
                  `GloNAF Western Cape` = b, 
                  `GloNAF South Africa` = c, 
                  `GloNAF Global`= d))
plot(fit,quantities = list(size = 12),type = "percent",labels = F,legend = list(size = 12))
```

**Supplementary figure 7**: Proportional Euler diagram of the inventory generated using the sANNIC workflow to the known naturalised and/or invasive species recorded in GloNAF in the Western Cape, South Africa, and globally respectively.







```{r eval=FALSE, include=FALSE}
## Code graveyard

# nonnative_inventory2%>%
#   group_by(lifeform_description)%>%
#   summarise(obs = length(taxon))%>%
#   mutate(lifeform = gsub("[[:punct:]]", "", lifeform_description)) %>%
#   separate_rows(lifeform, sep = " ")%>%
#   filter(lifeform != "or")%>%
#   group_by(lifeform,lifeform_description)%>%
#   summarise(obs = sum(obs))%>%
#   group_by(lifeform)%>%
#   mutate(sum_obs = sum(obs))%>%
#   mutate(lifeform = fct_reorder(lifeform,-sum_obs))%>%
#   rename(`Lifeform description` = lifeform_description)%>%
#   ggplot(aes(reorder(lifeform,-sum_obs),obs,fill = `Lifeform description`))+
#   geom_col()+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1),
#         legend.position = c(0.61,0.61))+
#   ylab("Number of species")+
#   xlab("Lifeform description")

# nonnative_inventory2%>%
#   group_by(lifeform_description)%>%
#   summarise(obs = length(taxon))%>%view()
#   mutate(lifeform = gsub("[[:punct:]]", "", lifeform_description)) %>%
#   separate_rows(lifeform, sep = " ")%>%
#   filter(lifeform != "or")%>%
#   group_by(lifeform,lifeform_description)%>%
#   summarise(obs = sum(obs))%>%
#   group_by(lifeform)%>%
#   mutate(sum_obs = sum(obs))%>%
#   mutate(lifeform = fct_reorder(lifeform,-sum_obs))%>%
#   rename(`Lifeform description` = lifeform_description)%>%
#   ggplot(aes(reorder(lifeform,-sum_obs),obs))+
#   geom_col()+
#   theme_bw()+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   ylab("Number of species")+
#   xlab("Lifeform description")
```






